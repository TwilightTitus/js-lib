de.titus.core.Namespace.create("de.titus.jstl.Processor", function() {
	
	
	/**
	 * <code>
	 * config: {
	 * "element": element,
	 * "data": dataContext,
	 * "domHelper": domHelper,
	 * "onLoad": function(){},
	 * "onSuccess":function(){},
	 * "onFail": function(){},
	 * "attributePrefix" : "jstl-" 
	 * }
	 * </code>
	 */
	de.titus.jstl.Processor = function(aConfig) {
		
		this.domHelper = aConfig.domHelper || de.titus.core.DomHelper.getInstance();
		this.config = {
			"data": {},
			"attributePrefix" : "jstl-" 
		};
		
		this.config = this.domHelper.mergeObjects(this.config, aConfig);
		
		
		this.rootElement = this.domHelper.toDomObject(this.config.element);
		this.rootDataContext = this.config.data;
		this.expressionResolver = new de.titus.jstl.ExpressionResolver(this.domHelper);
		
		this.onReadyEvent = new Array();
	};
	
	/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
	 * static variables
	 *********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
	de.titus.jstl.Processor.LOGGER = de.titus.logging.LoggerFactory.getInstance().newLogger("de.titus.jstl.Processor");
	
	/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
	 * functions
	 *********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
	
	de.titus.jstl.Processor.prototype.compute = /* boolean */function(aElement, aDataContext) {
		if (de.titus.jstl.Processor.LOGGER.isDebugEnabled())
			de.titus.jstl.Processor.LOGGER.logDebug("execute compute(" + aElement + ", " + aDataContext + ")");
		
		if (aElement == undefined)
			return this.internalComputeRoot();
		
		var events = this.getEvents(aElement) || {};
		return this.internalComputeElement(aElement, aDataContext, events, false);
	};
	
	de.titus.jstl.Processor.prototype.internalComputeRoot = /* boolean */function() {
		var events = this.getEvents(this.rootElement) || {};
		if(this.config.onLoad)
			events.onLoad = this.config.onLoad;
		if(this.config.onSuccess)
			events.onSuccess = this.config.onSuccess;
		if(this.config.onFail)
			events.onFail = this.config.onFail;		
		
		return this.internalComputeElement(this.rootElement, this.rootDataContext, events, true);
	};
	
	de.titus.jstl.Processor.prototype.internalComputeElement = /* boolean */function(aElement, aDataContext, theEvents, isRoot) {
		var dataContext = aDataContext || this.rootDataContext;
		
		if (theEvents.onLoad != undefined && this.domHelper.isFunction(theEvents.onLoad))
			theEvents.onLoad(aElement, aDataContext, this);
		
		var processResult = true;
		try {
			var result = this.internalExecuteFunction(aElement, dataContext);
			if (result.processChilds)
				this.internalComputeChilds(aElement, dataContext);
		} catch (e) {			
			de.titus.jstl.Processor.LOGGER.logError(e);
			processResult = false;
		}

		if (processResult && theEvents.onSuccess != undefined && this.domHelper.isFunction(theEvents.onSuccess))
				theEvents.onSuccess(aElement, aDataContext,this);
		else if (theEvents.onFail != undefined && this.domHelper.isFunction(theEvents.onFail))
				theEvents.onFail(aElement, aDataContext, this);	
		


		if(isRoot){
			var processor = this;
			this.domHelper.doOnReady(function(){			
				processor.onReady();
			});
		}
		
		return processResult;
	};
	
	de.titus.jstl.Processor.prototype.internalExecuteFunction = /* boolean */function(aElement, aDataContext) {
		if (de.titus.jstl.Processor.LOGGER.isDebugEnabled())
			de.titus.jstl.Processor.LOGGER.logDebug("execute internalExecuteFunction(" + aElement + ", " + aDataContext + ")");
		
		var functions = de.titus.jstl.FunctionRegistry.getInstance().functions;
		var result = new de.titus.jstl.FunctionResult();
		for (var i = 0; i < functions.length; i++) {
			var functionObject = functions[i];
			var executeFunction = this.isFunctionNeeded(functionObject, aElement);
			if (executeFunction) {
				var result = this.executeFunction(functionObject, aElement, aDataContext, result);
				if (!result.runNextFunction)
					return result;
			}
		}
		return result;
	};
	
	de.titus.jstl.Processor.prototype.internalComputeChilds = /* boolean */function(aElement, aDataContext) {
		if (de.titus.jstl.Processor.LOGGER.isDebugEnabled())
			de.titus.jstl.Processor.LOGGER.logDebug("execute internalComputeChilds(" + aElement + ", " + aDataContext + ")");
		
		var childs = this.domHelper.getChilds(aElement);
		if (childs == undefined)
			return true;
		else if (!this.domHelper.isArray(childs))
			return this.compute(childs, aDataContext);
		else {
			for (var i = 0; i < childs.length; i++) {
				var newElement = this.domHelper.toDomObject(childs[i]);
				if (!this.compute(newElement, aDataContext))
					return false;
			}
		}
		return true;
	};
	
	de.titus.jstl.Processor.prototype.getEvents = function(aElement) {
		var events = {};
		
		var onLoad = this.domHelper.getAttribute(aElement, this.config.attributePrefix + "load");
		var onSuccess = this.domHelper.getAttribute(aElement, this.config.attributePrefix + "success");
		var onFail = this.domHelper.getAttribute(aElement, this.config.attributePrefix + "fail");
		
		if (onLoad != null)
			events.onLoad = this.expressionResolver.resolveExpression(onLoad, {});
		if (onSuccess != null)
			events.onSuccess = this.expressionResolver.resolveExpression(onSuccess, {});
		if (onFail != null)
			events.onFail = this.expressionResolver.resolveExpression(onLoad, {});
		
		return events;
	};
	
	de.titus.jstl.Processor.prototype.isFunctionNeeded = function(aFunction, aElement) {
		if (de.titus.jstl.Processor.LOGGER.isDebugEnabled())
			de.titus.jstl.Processor.LOGGER.logDebug("execute isFunctionNeeded(" + aFunction + ", " + aElement + ")");
		
		var executeFunction = true;
		if (aFunction.attributeName != undefined && aFunction.attributeName != "") {
			var expression = this.domHelper.getAttribute(aElement, this.config.attributePrefix + aFunction.attributeName);
			executeFunction = expression != undefined;
		}
		
		return executeFunction;
	};
	
	de.titus.jstl.Processor.prototype.executeFunction = function(aFunction, aElement, aDataContext, aCurrentFunctionResult) {
		if (de.titus.jstl.Processor.LOGGER.isDebugEnabled())
			de.titus.jstl.Processor.LOGGER.logDebug("execute executeFunction(" + aFunction + ", " + aElement + ", " + aDataContext + ", " + aCurrentFunctionResult + ")");
		
		var result = aFunction.run(aElement, aDataContext, this);
		if (result != undefined) {
			aCurrentFunctionResult.runNextFunction = aCurrentFunctionResult.runNextFunction && result.runNextFunction;
			aCurrentFunctionResult.processChilds = aCurrentFunctionResult.processChilds && result.processChilds;
		}
		
		return aCurrentFunctionResult;
	};

	de.titus.jstl.Processor.prototype.onReady = function(aFunction) {
		if(aFunction)
			this.onReadyEvent.push(aFunction);
		else{
			for(var i = 0; i < this.onReadyEvent.length; i++)
			{
				try{
					this.onReadyEvent[i](this.rootElement, this);
				}
				catch (e) {
					de.titus.jstl.Processor.LOGGER.logError(e);
				}				
			}
		}
	};
});
